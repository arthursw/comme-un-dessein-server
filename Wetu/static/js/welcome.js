// Generated by CoffeeScript 1.12.7
(function() {
  var checkSurveyCompleted, finished, fullPage, loadLoginForm, nQuestions, nSections, sectionIndex, sliderSize, surveyNext, validateEmail;

  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      var getCookie;
      getCookie = function(name) {
        var cookie, cookieValue, cookies, i;
        cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          cookies = document.cookie.split(';');
          i = 0;
          while (i < cookies.length) {
            cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
            i++;
          }
        }
        return cookieValue;
      };
      if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
      }
    }
  });

  sectionIndex = 0;

  nQuestions = 4;

  nSections = 6;

  sliderSize = 250;

  finished = false;

  validateEmail = function(email) {
    var re;
    re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(email);
  };

  loadLoginForm = function() {
    finished = true;
    $.get("accounts/login/", (function(_this) {
      return function(data) {
        var doc, parser;
        parser = new DOMParser();
        doc = parser.parseFromString(data.html, "text/html");
        $('#login-form').html(doc.getElementById('login_form'));
        $('#id_login').attr('placeholder', "Nom d'utilisateur ou email");
        $('#id_username').attr('placeholder', "Nom d'utilisateur");
        $('label[for="id_remember"]').text('se souvenir de moi').css({
          'margin-left': '10px'
        }).parent().css({
          'display': 'flex',
          'flex-direction': 'row-reverse'
        });
        localStorage.setItem('just-logged-in', 'true');
        localStorage.setItem('selected-edition', location.pathname);
        $('#login-form').removeClass('hidden').show().addClass('visible');
      };
    })(this));
    return true;
  };

  checkSurveyCompleted = function() {
    var allSectionAnswered, j, len, requiredSection, requiredSections;
    requiredSections = $('.cd-required');
    allSectionAnswered = true;
    for (j = 0, len = requiredSections.length; j < len; j++) {
      requiredSection = requiredSections[j];
      if ($(requiredSection).find('.cd-radio.checked').length === 0) {
        allSectionAnswered = false;
      }
    }
    if (allSectionAnswered) {
      $('#survey-invalid').hide();
      $('#survey-email').removeClass('hidden').show();
    }
  };

  surveyNext = function() {
    fullpage_api.moveSlideRight();
  };

  fullPage = null;

  $(document).ready(function() {
    var black, blue, brown, buttons, colors, green, justLoggedIn, red, yellow;
    $('.section.cd-green').css({
      'background': 'url(static/css/pattern-green.png) repeat 0 0'
    });
    red = '#F44336';
    blue = '#2196F3';
    green = '#8BC34A';
    yellow = '#FFC107';
    brown = '#795548';
    black = '#000000';
    colors = [green, green, yellow, blue, green, brown, black];
    fullPage = new fullpage('#fullpage', {
      sectionsColor: colors,
      anchors: ['introduction', 'participer', 'participations'],
      loopHorizontal: false,
      navigation: true,
      navigationPosition: 'right',
      navigationTooltips: ['introduction', 'participer', 'participations'],
      slidesNavigation: true,
      controlArrows: false,
      onSlideLeave: (function(_this) {
        return function(section, origin, destination, direction) {
          console.log(section, origin, destination, direction);
        };
      })(this)
    });
    justLoggedIn = localStorage.getItem('just-logged-in') === 'true';
    if (justLoggedIn) {
      localStorage.removeItem('just-logged-in');
    }
    if (localStorage.getItem('selected-edition') !== null && justLoggedIn && $('.editions').attr('data-authenticated') === 'True') {
      window.location = localStorage.getItem('selected-edition');
      return;
    }
    buttons = $('.editions li').each((function(_this) {
      return function(index, element) {
        var buttonHref;
        buttonHref = $(element).find('a').attr('href');
        return $(element).click(function(e) {
          localStorage.setItem('selected-edition', buttonHref);
        });
      };
    })(this));
    $('#login-button').click(function(event) {
      loadLoginForm();
    });
    document.addEventListener("click", function(event) {
      var loginForm;
      loginForm = $('#login-form');
      if (loginForm.get(0) !== event.target && (!jQuery.contains(loginForm.get(0), event.target)) && loginForm.hasClass('visible')) {
        $('#login-form').hide().removeClass('visible');
      }
    });
    $('#app-button').click(function(event) {
      location.pathname = 'demo';
    });
    $('.next-button').click(function(event) {
      fullpage_api.moveSectionDown();
    });
    $('#submit-form').click(function(event) {
      event.preventDefault();
      event.stopPropagation();
      $('.participate-section').removeClass('hidden').show();
      $('#submit-form').hide();
      return -1;
    });
    $('.cd-radio').click(function(event) {
      event.preventDefault();
      event.stopPropagation();
      $(this).addClass('checked').siblings('.cd-radio').removeClass('checked');
      checkSurveyCompleted();
      if ($(this).hasClass('validate')) {
        $(this).parents('.cd-section').find('.cd-validate').removeClass('hidden').show();
      } else {
        setTimeout(surveyNext, 500);
      }
      return -1;
    });
    $('.cd-radio select').click(function(event) {
      event.preventDefault();
      event.stopPropagation();
      return -1;
    });
    $('.cd-radio select').on('change', function(event) {
      event.preventDefault();
      event.stopPropagation();
      $('.cd-radio').removeClass('checked');
      $(this).parents('.cd-radio').addClass('checked').siblings('.cd-radio').removeClass('checked');
      $(this).parents('.cd-section').find('.cd-validate').removeClass('hidden').show();
      return -1;
    });
    $('.cd-checkbox').click(function(event) {
      event.preventDefault();
      event.stopPropagation();
      $(this).toggleClass('checked');
      checkSurveyCompleted();
      $(this).parents('.cd-section').find('.cd-validate').removeClass('hidden').show();
      return -1;
    });
    $('.cd-validate button').click(function(event) {
      var answers, args, email, participate, toArray;
      event.preventDefault();
      event.stopPropagation();
      if ($(this).hasClass('email')) {
        email = $('#id_email').val();
        toArray = function(value) {
          if (value != null) {
            return [value];
          } else {
            return [];
          }
        };
        answers = {};
        participate = $('.cd-section.participate').find('.cd-radio.checked').attr('data-value');
        if (participate === 'as-soon-as') {
          participate = $('.cd-section.participate').find('.cd-radio select').val();
        }
        answers['participate'] = toArray(participate);
        answers['participate-event'] = $('.cd-section.participate-event').find('.cd-checkbox.checked').map(function() {
          return $(this).attr('data-value');
        }).toArray();
        answers['num-drawings'] = toArray($('.cd-section.num-drawings').find('.cd-radio.checked').attr('data-value'));
        answers['print-size'] = toArray($('.cd-section.print-size').find('.cd-radio.checked').attr('data-value'));
        args = {
          email: email,
          answers: answers
        };
        $.ajax({
          method: "POST",
          url: "ajaxCall/",
          data: {
            data: JSON.stringify({
              "function": 'submitSurvey',
              args: args
            })
          }
        }).done(function(result) {
          $('#survey-email').hide();
          $('.cd-validate.email').hide();
          if (result.status === 'error') {
            if (result.message === 'Your email is invalid') {
              $('#survey-error').removeClass('hidden').show();
              $('#survey-error p').text("Cette adresse email n'est pas valide.");
            }
            if (result.message === 'Some answers are not valid') {
              $('#survey-error').removeClass('hidden').show();
              $('#survey-error p').text("Certaines réponses ne sont pas valides.");
            }
          } else {
            $('#survey-sent').removeClass('hidden').show();
            if (result.message === 'Your participation was successfully updated') {
              $('#survey-sent h3').text('Votre participation a bien été mise à jour !');
            }
          }
        });
        return;
      }
      surveyNext();
      return -1;
    });
    Chart.defaults.global.defaultFontSize = 14;
    $.ajax({
      method: "POST",
      url: "ajaxCall/",
      data: {
        data: JSON.stringify({
          "function": 'getSurveyResults',
          args: {}
        })
      }
    }).done(function(result) {
      var canvasJ, chart, j, len, margins, n, questionObject, slideJ, surveyResultsJ, titleJ;
      surveyResultsJ = $('#survey-results');
      margins = 300;
      n = 0;
      for (j = 0, len = result.length; j < len; j++) {
        questionObject = result[j];
        canvasJ = $('<canvas>').attr('width', (window.innerWidth / 2 - margins) + 'px').attr('height', (window.innerHeight / 2 - margins) + 'px');
        slideJ = $(surveyResultsJ.find('.chart').get(n));
        titleJ = $('<h3>').text(questionObject.text);
        slideJ.append(titleJ);
        slideJ.append(canvasJ);
        chart = new Chart(canvasJ.get(0), {
          type: 'bar',
          data: {
            labels: questionObject.legends,
            datasets: [
              {
                label: questionObject.text,
                data: questionObject.answers,
                backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)', 'rgba(205, 220, 57, 0.2)'],
                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)', 'rgba(205, 220, 57, 1)'],
                borderWidth: 1
              }
            ]
          },
          options: {
            legend: {
              display: false
            },
            scales: {
              yAxes: [
                {
                  ticks: {
                    stepSize: 1
                  },
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: 'Nombre de votes'
                  }
                }
              ]
            }
          }
        });
        n++;
      }
    });
    $('#id_email').on("change paste keyup", function() {
      var text;
      text = $(this).val();
      if (validateEmail(text)) {
        $('.cd-validate').removeClass('hidden').show();
      } else {
        $('.cd-validate').hide();
      }
    });
  });

}).call(this);
